"""
–†–æ—É—Ç–µ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò ‚Äî –¥–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤.
"""
import os
import json
import logging
from typing import Optional
from pathlib import Path

from services.openai_client import openai_client
from data.fitness_rag import FitnessRAGSystem

logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ–∂–∏–º–æ–≤
user_modes = {}
user_data = {}  # –•—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ—Å—Ç, –≤–µ—Å, etc.


class RequestRouter:
    """–†–æ—É—Ç–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤."""
    
    def __init__(self):
        self.rag_system = None
    
    def get_rag_system(self) -> FitnessRAGSystem:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç RAG —Å–∏—Å—Ç–µ–º—É."""
        if self.rag_system is None:
            self.rag_system = FitnessRAGSystem()
        return self.rag_system
    
    def route_text_request(self, user_id: int, text: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        mode = user_modes.get(user_id, "text")
        text_lower = text.lower()
        
        if mode == "rag":
            return self.route_rag_request(user_id, text)
        elif mode == "image":
            # –í —Ä–µ–∂–∏–º–µ image –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
            exercise_keywords = ["—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ", "–∫–∞–∫ –¥–µ–ª–∞—Ç—å", "—Ç–µ—Ö–Ω–∏–∫–∞", "–ø–æ–∫–∞–∂–∏", "—Å—Ö–µ–º–∞", "—É–ø—Ä", "–ø—Ä–∏—Å–µ–¥", "–∂–∏–º", "–ø–æ–¥—Ç—è–≥", "–æ—Ç–∂–∏–º", "—Ç—è–≥–∞", "–ø–ª–∞–Ω–∫–∞", "–ø—Ä–µ—Å—Å", "–æ—Ç–∂–∏–º–∞–Ω–∏–µ", "–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ", "—Å—Ç–∞–Ω–æ–≤–∞—è", "–≤—ã–ø–∞–¥—ã", "–±–µ—Ä–ø–∏", "–ø—Ä—ã–∂–æ–∫"]
            if any(kw in text_lower for kw in exercise_keywords):
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                exercise_name = self._extract_exercise_name_from_text(text)
                if exercise_name:
                    # –í —Ä–µ–∂–∏–º–µ image - –ì–ï–ù–ï–†–ò–†–£–ï–ú –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é!
                    image_url = self.generate_exercise_image(exercise_name)
                    instruction = self.get_exercise_instruction(exercise_name)
                    
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è handler
                    if "pending_exercise_images" not in user_data:
                        user_data["pending_exercise_images"] = {}
                    user_data["pending_exercise_images"][user_id] = {
                        "image_url": image_url,
                        "instruction": instruction,
                        "exercise_name": exercise_name
                    }
                    
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è handler
                    return f"üé®_GENERATED_{exercise_name}_GENERATED_üé®\n\n{instruction}"
            
            # –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ - —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ –µ–¥—ã
            return "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –±–ª—é–¥–∞, –∏ —è –ø–æ—Å—á–∏—Ç–∞—é –∫–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£!"
        elif mode == "voice":
            # –í —Ä–µ–∂–∏–º–µ voice –æ—Ç–≤–µ—á–∞–µ–º –∫—Ä–∞—Ç–∫–æ, —á—Ç–æ–±—ã –∑–∞—Ç–µ–º –æ–∑–≤—É—á–∏—Ç—å
            return self._handle_voice_mode(user_id, text)

        # –¢–ï–ö–°–¢–û–í–´–ô –†–ï–ñ–ò–ú - –¥–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
        exercise_keywords = ["—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ", "–∫–∞–∫ –¥–µ–ª–∞—Ç—å", "—Ç–µ—Ö–Ω–∏–∫–∞", "–ø–æ–∫–∞–∂–∏", "—Å—Ö–µ–º–∞", "—É–ø—Ä", "–ø—Ä–∏—Å–µ–¥", "–∂–∏–º", "–ø–æ–¥—Ç—è–≥", "–æ—Ç–∂–∏–º", "—Ç—è–≥–∞", "–ø–ª–∞–Ω–∫–∞", "–ø—Ä–µ—Å—Å", "–æ—Ç–∂–∏–º–∞–Ω–∏–µ", "–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ", "—Å—Ç–∞–Ω–æ–≤–∞—è", "–≤—ã–ø–∞–¥—ã", "–º–∞—Ö–∏", "—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", "–ø–æ–¥—ä—ë–º", "–∂–∏–º–∞—Ç—å", "–ø—Ä–∏—Å–µ–¥–∞—Ç—å", "–ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å—Å—è", "–±–µ—Ä–ø–∏", "–ø—Ä—ã–∂–æ–∫"]
        if any(kw in text_lower for kw in exercise_keywords):
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            exercise_name = self._extract_exercise_name_from_text(text)
            if exercise_name:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                instruction = self.get_exercise_instruction(exercise_name)
                return f"üìã **–¢–µ—Ö–Ω–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {exercise_name}**\n\n{instruction}\n\nüí° –î–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–π —Å—Ö–µ–º—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Å—å –≤ —Ä–µ–∂–∏–º: /mode image"

        # –ë–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
        return self._handle_text_with_context(user_id, text)
    
    def _handle_voice_mode(self, user_id: int, text: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º —Ä–µ–∂–∏–º–µ - –æ—Ç–≤–µ—á–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ –¥–ª—è TTS."""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id in user_data and user_data[user_id].get("profile_complete"):
            profile = user_data[user_id]
            
            messages = [
                {
                    "role": "system",
                    "content": f"""–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
- –í–æ–∑—Ä–∞—Å—Ç: {profile.get('age', '–Ω–µ —É–∫–∞–∑–∞–Ω')}
- –†–æ—Å—Ç: {profile.get('height', '–Ω–µ —É–∫–∞–∑–∞–Ω')} —Å–º
- –í–µ—Å: {profile.get('weight', '–Ω–µ —É–∫–∞–∑–∞–Ω')} –∫–≥
- –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: {profile.get('activity_level', '–Ω–µ —É–∫–∞–∑–∞–Ω')}
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {profile.get('limitations', '–Ω–µ—Ç')}
- –¶–µ–ª—å: {profile.get('goal', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}

–û—Ç–≤–µ—á–∞–π –ö–†–ê–¢–ö–û (–Ω–µ –±–æ–ª–µ–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —Ö–æ—Ä–æ—à–æ –∑–≤—É—á–∞—Ç—å –ø—Ä–∏ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–∏ - –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤."""
                },
                {"role": "user", "content": text}
            ]
        else:
            messages = [
                {
                    "role": "system",
                    "content": """–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Ñ–æ—Ä–º—ã —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.
–û—Ç–≤–µ—á–∞–π –ö–†–ê–¢–ö–û (–Ω–µ –±–æ–ª–µ–µ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π), –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
–¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω —Ö–æ—Ä–æ—à–æ –∑–≤—É—á–∞—Ç—å –ø—Ä–∏ –æ–∑–≤—É—á–∏–≤–∞–Ω–∏–∏ - –±–µ–∑ markdown, —ç–º–æ–¥–∑–∏ –∏—Å–ø–æ–ª—å–∑—É–π —É–º–µ—Ä–µ–Ω–Ω–æ.
–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å —Ñ–∏—Ç–Ω–µ—Å–æ–º/–∑–¥–æ—Ä–æ–≤—å–µ–º/–ø–∏—Ç–∞–Ω–∏–µ–º - –∫—Ä–∞—Ç–∫–æ —Å–æ–æ–±—â–∏, —á—Ç–æ —Ç—ã —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –∏ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏."""
                },
                {"role": "user", "content": text}
            ]

        return openai_client.chat_completion(messages, temperature=0.7)
    
    def _extract_exercise_name_from_text(self, text: str) -> Optional[str]:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞."""
        import re

        text_lower = text.lower()

        # –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Å –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏
        known_exercises = {
            "–ø—Ä–∏—Å–µ–¥": ["–ø—Ä–∏—Å–µ–¥", "–ø—Ä–∏—Å–µ–¥–∞–Ω–∏—è", "–ø—Ä–∏—Å–µ–¥–∞—Ç—å", "squat", "–≥–ª—É–±–æ–∫–∏–π –ø—Ä–∏—Å–µ–¥"],
            "–∂–∏–º –ª—ë–∂–∞": ["–∂–∏–º –ª—ë–∂–∞", "–∂–∏–º –Ω–∞ –≥—Ä—É–¥—å", "bench press", "–∂–∏–º", "–∂–∏–º —à—Ç–∞–Ω–≥–∏ –ª—ë–∂–∞"],
            "–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ": ["–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ", "–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è", "–ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å—Å—è", "pull up", "–ø–æ–¥—Ç—è–≥"],
            "–æ—Ç–∂–∏–º–∞–Ω–∏–µ": ["–æ—Ç–∂–∏–º–∞–Ω–∏–µ", "–æ—Ç–∂–∏–º–∞–Ω–∏—è", "–æ—Ç–∂–∏–º–∞—Ç—å—Å—è", "push up"],
            "—Å—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞": ["—Å—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞", "deadlift", "—Ç—è–≥–∞ —Å –ø–æ–ª–∞"],
            "–≤—ã–ø–∞–¥—ã": ["–≤—ã–ø–∞–¥—ã", "–≤—ã–ø–∞–¥—ã –≤–ø–µ—Ä—ë–¥", "lunges", "—à–∞–≥"],
            "–ø–ª–∞–Ω–∫–∞": ["–ø–ª–∞–Ω–∫–∞", "plank", "—Å—Ç–æ—è—Ç—å –≤ –ø–ª–∞–Ω–∫–µ"],
            "—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è": ["—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è", "—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏–µ", "–∫—Ä–∞–Ω—á–∏", "crunch –Ω–∞ –ø—Ä–µ—Å—Å"],
            "–ø—Ä–µ—Å—Å": ["–ø—Ä–µ—Å—Å", "–∂–∏–≤–æ—Ç", "–∫—É–±–∏–∫–∏ –ø—Ä–µ—Å—Å–∞"],
            "–º–∞—Ö–∏": ["–º–∞—Ö–∏", "–º–∞—Ö–∏ —Ä—É–∫–∞–º–∏", "–º–∞—Ö–∏ –Ω–æ–≥–∞–º–∏", "lateral raise"],
            "—Ç—è–≥–∞": ["—Ç—è–≥–∞", "—Ç—è–≥–∞ —à—Ç–∞–Ω–≥–∏", "—Ç—è–≥–∞ –≥–∞–Ω—Ç–µ–ª–∏", "rowing", "–≤–µ—Å–ª–æ"],
            "–ø–æ–¥—ä—ë–º –Ω–æ–≥": ["–ø–æ–¥—ä—ë–º –Ω–æ–≥", "leg raise", "–Ω–æ–≥–∏ –ª—ë–∂–∞"],
            "–±–µ—Ä–ø–∏": ["–±–µ—Ä–ø–∏", "burpee", "burpees", "–±–µ—Ä–ø", "–±—ë—Ä–ø–∏"],
        }
        
        # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        for exercise, keywords in known_exercises.items():
            if any(kw in text_lower for kw in keywords):
                return exercise
        
        # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∏–∑ —Ñ—Ä–∞–∑—ã "–∫–∞–∫ –¥–µ–ª–∞—Ç—å X"
        match = re.search(r'–∫–∞–∫\s+(?:–¥–µ–ª–∞—Ç—å|–≤—ã–ø–æ–ª–Ω—è—Ç—å)\s+([–∞-—è—ë]+)', text_lower)
        if match:
            found_word = match.group(1)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–ª—É–∂–µ–±–Ω—ã–º —Å–ª–æ–≤–æ–º
            stop_words = ["—ç—Ç–æ", "—Ç–∞–∫–æ–µ", "–º–Ω–µ", "—Ç–µ–±–µ", "–µ–º—É", "–µ–π", "–Ω–∞—Å", "–≤–∞—Å", "–Ω–∏—Ö", "—á—Ç–æ", "–∫–æ–≥–¥–∞", "–≥–¥–µ", "–∫–∞–∫"]
            if found_word not in stop_words:
                return found_word
        
        # –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ—Å–ª–µ "—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ"
        match = re.search(r'—É–ø—Ä–∞–∂–Ω–µ–Ω(?:–∏–µ|—è|–µ–Ω–∏–∏|–µ–Ω–∏–π)\s+(?:–Ω–∞\s+)?(?:–¥–ª—è\s+)?(?:–º—ã—à—Ü\s+)?([–∞-—è—ë]+)', text_lower)
        if match:
            return match.group(1).strip()
        
        return None
    
    def route_voice_request(self, user_id: int, audio_path: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å."""
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≥–æ–ª–æ—Å –≤ —Ç–µ–∫—Å—Ç
        text = openai_client.transcribe_audio(audio_path)
        logger.info(f"–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id}: {text}")
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
        return self.route_text_request(user_id, text)
    
    def route_image_request(self, user_id: int, image_path: str, caption: str = "") -> str:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            image_path: –ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
            caption: –¢–µ–∫—Å—Ç –ø–æ–¥–ø–∏—Å–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º - –µ—Å–ª–∏ –Ω–µ image, —Å–æ–æ–±—â–∞–µ–º –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        mode = user_modes.get(user_id, "text")
        if mode != "image":
            return ("üì∏ –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º **/mode image**!\n\n"
                    "–í —Ä–µ–∂–∏–º–µ image –≤—ã –º–æ–∂–µ—Ç–µ:\n"
                    "‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –µ–¥—ã ‚Üí —É–∑–Ω–∞—Ç—å –∫–∞–ª–æ—Ä–∏–∏ –∏ –ë–ñ–£\n"
                    "‚Ä¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ —Å –≤–æ–ø—Ä–æ—Å–æ–º –æ–± —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–∏ ‚Üí –ø–æ–ª—É—á–∏—Ç—å —Å—Ö–µ–º—É")
        
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç - —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ
            if caption:
                caption_lower = caption.lower()
                exercise_keywords = ["—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ", "–∫–∞–∫ –¥–µ–ª–∞—Ç—å", "—Ç–µ—Ö–Ω–∏–∫–∞", "–ø–æ–∫–∞–∂–∏", "—Å—Ö–µ–º–∞", "—É–ø—Ä", "–ø—Ä–∏—Å–µ–¥", "–∂–∏–º", "–ø–æ–¥—Ç—è–≥", "–æ—Ç–∂–∏–º", "—Ç—è–≥–∞", "–ø–ª–∞–Ω–∫–∞"]
                if any(kw in caption_lower for kw in exercise_keywords):
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    exercise_name = self._extract_exercise_name_from_text(caption)
                    if exercise_name:
                        return self._handle_exercise_generation(user_id, exercise_name)

            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ–¥–∞ –ª–∏ —ç—Ç–æ
            is_food = self._check_if_food(image_path)
            
            if not is_food:
                import random
                jokes = [
                    "üòÑ –í—Å—ë –∏–º–µ–µ—Ç –∫–∞–ª–æ—Ä–∏–∏, –Ω–æ —ç—Ç–æ—Ç –∫–æ—Ç/–ø–µ–π–∑–∞–∂/–º–∞—à–∏–Ω–∞ –Ω–µ –æ—á–µ–Ω—å-—Ç–æ —Å—ä–µ–¥–æ–±–µ–Ω! –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –µ–¥—ã ‚Äî –ø–æ—Å—á–∏—Ç–∞—é –∫–∞–ª–æ—Ä–∏–∏!",
                    "üçΩÔ∏è –ö—Ä–∞—Å–∏–≤–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞, –Ω–æ —è —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä, –∞ –Ω–µ –¥–∏–µ—Ç–æ–ª–æ–≥ –¥–ª—è –∫–æ—Ç–æ–≤! –î–∞–π –ª—É—á—à–µ —Ñ–æ—Ç–æ –±–ª—é–¥–∞!",
                    "ü§î –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —Ñ–æ—Ç–æ! –ù–æ —è –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å –µ–¥–æ–π. –≠—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –±–æ—Ä—â? üôÉ",
                ]
                return random.choice(jokes)
                
            # –ï—Å–ª–∏ –µ–¥–∞ ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª–æ—Ä–∏–∏
            result = openai_client.analyze_image(
                image_path,
                prompt="""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –±–ª—é–¥–æ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:
1. –ß—Ç–æ —ç—Ç–æ –∑–∞ –±–ª—é–¥–æ
2. –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π
3. –ë–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã (–ë–ñ–£)
4. –ö—Ä–∞—Ç–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è —Ñ–∏—Ç–Ω–µ—Å–∞

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üçΩÔ∏è **–ë–ª—é–¥–æ:** [–Ω–∞–∑–≤–∞–Ω–∏–µ]
üìä **–ö–∞–ª–æ—Ä–∏–∏:** ~XXX –∫–∫–∞–ª
üí™ **–ë–µ–ª–∫–∏:** X–≥ | **–ñ–∏—Ä—ã:** X–≥ | **–£–≥–ª–µ–≤–æ–¥—ã:** X–≥
‚≠ê **–û—Ü–µ–Ω–∫–∞:** [–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π]"""
            )
            return result
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            import traceback
            logger.error(traceback.format_exc())
            return "üòî –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    
    def _handle_exercise_generation(self, user_id: int, exercise_name: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."""
        try:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            image_url = self.generate_exercise_image(exercise_name)

            if image_url:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                instruction = self.get_exercise_instruction(exercise_name)

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ handler
                if "pending_exercise_images" not in user_data:
                    user_data["pending_exercise_images"] = {}
                user_data["pending_exercise_images"][user_id] = {
                    "image_url": image_url,
                    "instruction": instruction,
                    "exercise_name": exercise_name
                }

                return f"üé®_GENERATED_{exercise_name}_GENERATED_üé®"
            else:
                instruction = self.get_exercise_instruction(exercise_name)
                return f"üé®_TEXT_ONLY_{exercise_name}_TEXT_ONLY_\n\n{instruction}"

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: {e}")
            instruction = self.get_exercise_instruction(exercise_name)
            return f"üòî –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.\n\n{instruction}"
    
    def _check_if_food(self, image_path: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ–¥–æ–π."""
        try:
            result = openai_client.analyze_image(
                image_path,
                prompt="–û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º: FOOD –µ—Å–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ –µ–¥–∞/–Ω–∞–ø–∏—Ç–æ–∫, NOT_FOOD –µ—Å–ª–∏ –Ω–µ—Ç. –¢–æ–ª—å–∫–æ —Å–ª–æ–≤–æ."
            )
            return "FOOD" in result.upper()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
            return True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º –µ–¥–æ–π
    
    def route_rag_request(self, user_id: int, query: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç RAG –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π."""
        try:
            rag = self.get_rag_system()
            
            # –ò—â–µ–º –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
            results = rag.search_exercises(query, n_results=3)
            
            if results:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                context = "\n\n".join([r['text'] for r in results if 'text' in r])
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º LLM —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
                messages = [
                    {
                        "role": "system",
                        "content": """–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. –ò—Å–ø–æ–ª—å–∑—É–π –Ω–∞–π–¥–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π 
                        –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, 
                        –º–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ –æ —Ñ–∏—Ç–Ω–µ—Å–µ."""
                    },
                    {
                        "role": "user",
                        "content": f"–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n{context}\n\n–í–æ–ø—Ä–æ—Å: {query}"
                    }
                ]
                
                return openai_client.chat_completion(messages, temperature=0.5)
            else:
                # –ï—Å–ª–∏ –≤ RAG –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º LLM
                return self._handle_text_with_context(user_id, query)
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ RAG –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return self._handle_text_with_context(user_id, query)
    
    def _handle_text_with_context(self, user_id: int, text: str) -> str:
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø–æ–ª–Ω–µ–Ω –ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_id in user_data and user_data[user_id].get("profile_complete"):
            profile = user_data[user_id]
            
            messages = [
                {
                    "role": "system",
                    "content": f"""–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
- –í–æ–∑—Ä–∞—Å—Ç: {profile.get('age', '–Ω–µ —É–∫–∞–∑–∞–Ω')}
- –†–æ—Å—Ç: {profile.get('height', '–Ω–µ —É–∫–∞–∑–∞–Ω')} —Å–º
- –í–µ—Å: {profile.get('weight', '–Ω–µ —É–∫–∞–∑–∞–Ω')} –∫–≥
- –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: {profile.get('activity_level', '–Ω–µ —É–∫–∞–∑–∞–Ω')}
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {profile.get('limitations', '–Ω–µ—Ç')}
- –¶–µ–ª—å: {profile.get('goal', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞')}

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ù–µ –±–æ–ª–µ–µ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π."""
                },
                {"role": "user", "content": text}
            ]
        else:
            messages = [
                {
                    "role": "system",
                    "content": """–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Ñ–æ—Ä–º—ã —Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.
                    –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. 
                    –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ —Å–≤—è–∑–∞–Ω —Å —Ñ–∏—Ç–Ω–µ—Å–æ–º/–∑–¥–æ—Ä–æ–≤—å–µ–º/–ø–∏—Ç–∞–Ω–∏–µ–º - –∫—Ä–∞—Ç–∫–æ —Å–æ–æ–±—â–∏, —á—Ç–æ —Ç—ã —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä 
                    –∏ –≤ –¥—Ä—É–≥–∏—Ö —Ç–µ–º–∞—Ö –Ω–µ —Ä–∞–∑–±–∏—Ä–∞–µ—à—å—Å—è (–º–æ–∂–Ω–æ —Å —é–º–æ—Ä–æ–º: "–Ø —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä, –∞ –Ω–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä! üèãÔ∏è")."""
                },
                {"role": "user", "content": text}
            ]

        return openai_client.chat_completion(messages, temperature=0.7)
    
    def generate_workout(
        self,
        user_id: int,
        week: int,
        day: int,
        previous_workout: Optional[dict] = None
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG."""
        try:
            rag = self.get_rag_system()
            profile = user_data.get(user_id, {})
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏–∑ RAG
            workout = rag.get_workout_plan(
                gender=profile.get('gender', 'male'),
                age_group=profile.get('age_group', '18-30'),
                week=week,
                day=day
            )
            
            if workout:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                workout_text = self._format_workout(workout, week, day)
                
                # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞, –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É
                if previous_workout:
                    workout_text += "\n\nüí™ –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–æ–π!"
                
                # –£—á–∏—Ç—ã–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                if profile.get('limitations'):
                    workout_text += f"\n\n‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: {profile['limitations']}"
                
                return workout_text
            
            # –ï—Å–ª–∏ –≤ RAG –Ω–µ—Ç –ø–ª–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º LLM
            return self._generate_workout_with_llm(user_id, week, day, profile)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: {e}")
            return self._generate_workout_with_llm(user_id, week, day, profile)
    
    def _format_workout(self, workout: dict, week: int, day: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –¥–ª—è –≤—ã–≤–æ–¥–∞."""
        lines = [
            f"üèãÔ∏è **–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ {week}.{day} –¥–µ–Ω—å**",
            "",
            f"üìù *{workout.get('name', '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞')}*",
            "",
        ]
        
        # –†–∞–∑–º–∏–Ω–∫–∞
        if 'warmup' in workout:
            lines.append("üî• **–†–∞–∑–º–∏–Ω–∫–∞:**")
            for exercise in workout['warmup'][:3]:
                lines.append(f"  ‚Ä¢ {exercise}")
            lines.append("")
        
        # –û—Å–Ω–æ–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        if 'exercises' in workout:
            lines.append("üí™ **–û—Å–Ω–æ–≤–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:**")
            for i, exercise in enumerate(workout['exercises'], 1):
                if isinstance(exercise, dict):
                    lines.append(f"  {i}. **{exercise.get('name', '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ')}**")
                    lines.append(f"     –ü–æ–¥—Ö–æ–¥—ã: {exercise.get('sets', 3)} | –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: {exercise.get('reps', '10-12')}")
                    if exercise.get('rest'):
                        lines.append(f"     –û—Ç–¥—ã—Ö: {exercise['rest']} —Å–µ–∫")
                else:
                    lines.append(f"  {i}. {exercise}")
            lines.append("")
        
        # –ó–∞–º–∏–Ω–∫–∞
        if 'cooldown' in workout:
            lines.append("üßò **–ó–∞–º–∏–Ω–∫–∞:**")
            for exercise in workout['cooldown'][:2]:
                lines.append(f"  ‚Ä¢ {exercise}")
        
        return "\n".join(lines)
    
    def _generate_workout_with_llm(
        self,
        user_id: int,
        week: int,
        day: int,
        profile: dict
    ) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ LLM –µ—Å–ª–∏ RAG –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."""
        goal = profile.get('goal', '–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã')
        limitations = profile.get('limitations', '–Ω–µ—Ç')
        
        messages = [
            {
                "role": "system",
                "content": f"""–¢—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. –°–æ—Å—Ç–∞–≤—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–∞ –¥–µ–Ω—å {week}-–π –Ω–µ–¥–µ–ª–∏.
                –¶–µ–ª—å: {goal}
                –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: {limitations}
                
                –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞: –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Å –ø–æ–¥—Ö–æ–¥–∞–º–∏ –∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏.
                –ù–µ –±–æ–ª–µ–µ 5 —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º."""
            },
            {"role": "user", "content": f"–°–æ—Å—Ç–∞–≤—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É {week}.{day} –¥–µ–Ω—å"}
        ]
        
        return openai_client.chat_completion(messages, temperature=0.7)
    
    def generate_exercise_image(self, exercise_name: str) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ö–µ–º–∞—Ç–∏—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."""
        try:
            prompt = f"""–°—Ö–µ–º–∞—Ç–∏—á–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: {exercise_name}. 
            –ü—Ä–æ—Å—Ç–æ–π —á–µ—Ä–Ω–æ-–±–µ–ª—ã–π –∫–æ–Ω—Ç—É—Ä–Ω—ã–π —Ä–∏—Å—É–Ω–æ–∫ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–π —Ñ–∏–≥—É—Ä—ã, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–π –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É.
            –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Å—Ç–∏–ª—å, –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ö–µ–º–∞, –≤–∏–¥ —Å–±–æ–∫—É."""
            
            return openai_client.generate_image(prompt, size="1024x1024")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: {e}")
            return None

    def get_exercise_instruction(self, exercise_name: str) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."""
        try:
            messages = [
                {
                    "role": "system",
                    "content": """–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å –∫—Ä–∞—Ç–∫—É—é, –ø–æ–Ω—è—Ç–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Ç–µ—Ö–Ω–∏–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è.
                    –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É—è –º–∞—Ä–∫–µ—Ä—ã –∏ —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏.
                    –ù–µ –±–æ–ª–µ–µ 150 —Å–ª–æ–≤. –£–∫–∞–∂–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã—Ö —Å–ª–µ–¥—É–µ—Ç –∏–∑–±–µ–≥–∞—Ç—å."""
                },
                {
                    "role": "user",
                    "content": f"–û–ø–∏—à–∏ —Ç–µ—Ö–Ω–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: {exercise_name}"
                }
            ]

            return openai_client.chat_completion(messages, temperature=0.5, max_tokens=500)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: {e}")
            return self._get_default_exercise_instruction(exercise_name)
    
    def _get_default_exercise_instruction(self, exercise_name: str) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è."""
        instructions = {
            "–ø—Ä–∏—Å–µ–¥": """üèãÔ∏è **–ü—Ä–∏—Å–µ–¥** - –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≥–∏

‚Ä¢ –í—Å—Ç–∞–Ω—å—Ç–µ, –Ω–æ–≥–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á, –Ω–æ—Å–∫–∏ —Å–ª–µ–≥–∫–∞ —Ä–∞–∑–≤–µ–¥–µ–Ω—ã
‚Ä¢ –°–ø–∏–Ω–∞ –ø—Ä—è–º–∞—è, –≤–∑–≥–ª—è–¥ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤–ø–µ—Ä–µ–¥
‚Ä¢ –û–ø—É—Å–∫–∞–π—Ç–µ—Å—å –º–µ–¥–ª–µ–Ω–Ω–æ, –æ—Ç–≤–æ–¥—è —Ç–∞–∑ –Ω–∞–∑–∞–¥
‚Ä¢ –ö–æ–ª–µ–Ω–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –Ω–æ—Å–∫–∏
‚Ä¢ –û–ø—É—Å—Ç–∏—Ç–µ—Å—å –¥–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏ –±—ë–¥–µ—Ä —Å –ø–æ–ª–æ–º
‚Ä¢ –ü–æ–¥–Ω–∏–º–∞–π—Ç–µ—Å—å, –∏—Å–ø–æ–ª—å–∑—É—è –º—ã—à—Ü—ã –Ω–æ–≥ –∏ —è–≥–æ–¥–∏—Ü

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –æ–∫—Ä—É–≥–ª—è–π—Ç–µ —Å–ø–∏–Ω—É, –Ω–µ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ –ø—è—Ç–∫–∏, –Ω–µ —Ä–∞–∑–≤–æ–¥–∏—Ç–µ –∫–æ–ª–µ–Ω–∏ –≤–Ω—É—Ç—Ä—å""",

            "–∂–∏–º –ª—ë–∂–∞": """üèãÔ∏è **–ñ–∏–º –ª—ë–∂–∞** - –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –≥—Ä—É–¥—å

‚Ä¢ –õ—è–≥—Ç–µ –Ω–∞ —Å–∫–∞–º—å—é, —Å—Ç–æ–ø—ã –ø–ª–æ—Ç–Ω–æ –Ω–∞ –ø–æ–ª—É
‚Ä¢ –í–æ–∑—å–º–∏—Ç–µ –≥—Ä–∏—Ñ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á
‚Ä¢ –û–ø—É—Å–∫–∞–π—Ç–µ –≥—Ä–∏—Ñ –º–µ–¥–ª–µ–Ω–Ω–æ –∫ –≥—Ä—É–¥–∏
‚Ä¢ –õ–æ–∫—Ç–∏ –ø–æ–¥ —É–≥–ª–æ–º ~45¬∞ –∫ —Ç–µ–ª—É
‚Ä¢ –ñ–º–∏—Ç–µ –≤–≤–µ—Ä—Ö, –≤—ã–ø—Ä—è–º–ª—è—è —Ä—É–∫–∏
‚Ä¢ –ù–µ –≤—ã–≥–∏–±–∞–π—Ç–µ —Å–∏–ª—å–Ω–æ —Å–ø–∏–Ω—É

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –æ—Ç—Ä—ã–≤–∞–π—Ç–µ –ø–æ–ø—É –æ—Ç —Å–∫–∞–º—å–∏, –Ω–µ "—à–ª–µ–ø–∞–π—Ç–µ" –≥—Ä–∏—Ñ –æ –≥—Ä—É–¥—å""",

            "–ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ": """üèãÔ∏è **–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏–µ** - –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Å–ø–∏–Ω—É

‚Ä¢ –ü–æ–≤–∏—Å–Ω–∏—Ç–µ –Ω–∞ —Ç—É—Ä–Ω–∏–∫–µ, —Ö–≤–∞—Ç —á—É—Ç—å —à–∏—Ä–µ –ø–ª–µ—á
‚Ä¢ –ù–∞ –≤–¥–æ—Ö–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–π—Ç–µ—Å—å, —Å–≤–æ–¥—è –ª–æ–ø–∞—Ç–∫–∏
‚Ä¢ –ü–æ–¥–±–æ—Ä–æ–¥–æ–∫ –¥–æ–ª–∂–µ–Ω –æ–∫–∞–∑–∞—Ç—å—Å—è –≤—ã—à–µ –ø–µ—Ä–µ–∫–ª–∞–¥–∏–Ω—ã
‚Ä¢ –ù–∞ –≤—ã–¥–æ—Ö–µ –æ–ø—É—Å–∫–∞–π—Ç–µ—Å—å –≤–Ω–∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ
‚Ä¢ –ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø—Ä—è–º–ª—è–π—Ç–µ —Ä—É–∫–∏ –≤ –Ω–∏–∂–Ω–µ–π —Ç–æ—á–∫–µ

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–µ—Ä—Ü–∏—é, –Ω–µ –≥–æ—Ä–±–∏—Ç–µ—Å—å""",

            "–æ—Ç–∂–∏–º–∞–Ω–∏–µ": """üèãÔ∏è **–û—Ç–∂–∏–º–∞–Ω–∏–µ** - –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –≥—Ä—É–¥—å –∏ —Ç—Ä–∏—Ü–µ–ø—Å

‚Ä¢ –£–ø–æ—Ä –ª—ë–∂–∞, —Ä—É–∫–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á
‚Ä¢ –ö–æ—Ä–ø—É—Å –ø—Ä—è–º–æ–π, –ø—Ä–µ—Å—Å –Ω–∞–ø—Ä—è–∂—ë–Ω
‚Ä¢ –û–ø—É—Å–∫–∞–π—Ç–µ—Å—å –¥–æ –∫–∞—Å–∞–Ω–∏—è –ø–æ–ª–∞ –≥—Ä—É–¥—å—é
‚Ä¢ –õ–æ–∫—Ç–∏ –ø–æ–¥ —É–≥–ª–æ–º ~45¬∞ –∫ —Ç–µ–ª—É
‚Ä¢ –û—Ç–∂–∏–º–∞–π—Ç–µ—Å—å –≤–≤–µ—Ä—Ö, –≤—ã–ø—Ä—è–º–ª—è—è —Ä—É–∫–∏

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –ø—Ä–æ–≥–∏–±–∞–π—Ç–µ—Å—å –ø–æ—è—Å–Ω–∏—Ü–µ–π, –Ω–µ "—Ä–∞–∑–≤–æ–¥–∏—Ç–µ" –ª–æ–∫—Ç–∏ –≤ —Å—Ç–æ—Ä–æ–Ω—ã""",

            "—Å—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞": """üèãÔ∏è **–°—Ç–∞–Ω–æ–≤–∞—è —Ç—è–≥–∞** - –±–∞–∑–æ–≤–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ —Å–ø–∏–Ω—É –∏ –Ω–æ–≥–∏

‚Ä¢ –í—Å—Ç–∞–Ω—å—Ç–µ –æ–∫–æ–ª–æ —à—Ç–∞–Ω–≥–∏, —Å—Ç–æ–ø—ã –Ω–∞ —à–∏—Ä–∏–Ω–µ —Ç–∞–∑–∞
‚Ä¢ –ù–∞–∫–ª–æ–Ω–∏—Ç–µ—Å—å, –≤–æ–∑—å–º–∏—Ç–µ—Å—å –∑–∞ –≥—Ä–∏—Ñ —á—É—Ç—å —à–∏—Ä–µ –ø–ª–µ—á
‚Ä¢ –°–ø–∏–Ω–∞ –ø—Ä—è–º–∞—è, –≤–∑–≥–ª—è–¥ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –≤–ø–µ—Ä–µ–¥
‚Ä¢ –ü–æ–¥–Ω–∏–º–∏—Ç–µ —à—Ç–∞–Ω–≥—É, –≤—ã–ø—Ä—è–º–ª—è—è –Ω–æ–≥–∏ –∏ —Å–ø–∏–Ω—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
‚Ä¢ –ë—ë–¥—Ä–∞ –∏ –∫–æ–ª–µ–Ω–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø—Ä—è–º–ª—è—é—Ç—Å—è –≤–≤–µ—Ä—Ö—É
‚Ä¢ –û–ø—É—Å—Ç–∏—Ç–µ —à—Ç–∞–Ω–≥—É –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –æ–∫—Ä—É–≥–ª—è–π—Ç–µ —Å–ø–∏–Ω—É, –Ω–µ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ —à—Ç–∞–Ω–≥—É –º—ã—à—Ü–∞–º–∏ —Å–ø–∏–Ω—ã —Å–Ω–∞—á–∞–ª–∞""",

            "–≤—ã–ø–∞–¥—ã": """üèãÔ∏è **–í—ã–ø–∞–¥—ã** - —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≥–∏ –∏ —è–≥–æ–¥–∏—Ü—ã

‚Ä¢ –í—Å—Ç–∞–Ω—å—Ç–µ –ø—Ä—è–º–æ, –Ω–æ–≥–∏ –Ω–∞ —à–∏—Ä–∏–Ω–µ –ø–ª–µ—á
‚Ä¢ –®–∞–≥–Ω–∏—Ç–µ –≤–ø–µ—Ä—ë–¥ –∏ –æ–ø—É—Å—Ç–∏—Ç–µ—Å—å
‚Ä¢ –ö–æ–ª–µ–Ω–æ –ø–µ—Ä–µ–¥–Ω–µ–π –Ω–æ–≥–∏ –ø–æ–¥ —É–≥–ª–æ–º 90¬∞
‚Ä¢ –ö–æ–ª–µ–Ω–æ –∑–∞–¥–Ω–µ–π –Ω–æ–≥–∏ –ø–æ—á—Ç–∏ –∫–∞—Å–∞–µ—Ç—Å—è –ø–æ–ª–∞
‚Ä¢ –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
‚Ä¢ –ß–µ—Ä–µ–¥—É–π—Ç–µ –Ω–æ–≥–∏ –∏–ª–∏ –¥–µ–ª–∞–π—Ç–µ –Ω–∞ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –Ω–∞–∫–ª–æ–Ω—è–π—Ç–µ—Å—å –≤–ø–µ—Ä—ë–¥, –∫–æ–ª–µ–Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ –Ω–æ—Å–æ–∫""",

            "–ø–ª–∞–Ω–∫–∞": """üèãÔ∏è **–ü–ª–∞–Ω–∫–∞** - —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ—Å—Å –∏ –∫–æ—Ä–∞

‚Ä¢ –£–ø–æ—Ä –ª—ë–∂–∞ –Ω–∞ –ø—Ä–µ–¥–ø–ª–µ—á—å—è—Ö
‚Ä¢ –õ–æ–∫—Ç–∏ –ø–æ–¥ –ø–ª–µ—á–∞–º–∏, —Ç–µ–ª–æ –ø—Ä—è–º–æ –æ—Ç –≥–æ–ª–æ–≤—ã –¥–æ –ø—è—Ç–æ–∫
‚Ä¢ –ü—Ä–µ—Å—Å –∏ —è–≥–æ–¥–∏—Ü—ã –Ω–∞–ø—Ä—è–∂–µ–Ω—ã
‚Ä¢ –ù–µ –ø—Ä–æ–≤–∏—Å–∞–π—Ç–µ –∏ –Ω–µ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ —Ç–∞–∑
‚Ä¢ –î—ã—à–∏—Ç–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ –ø–æ–ø—É, –Ω–µ –æ–ø—É—Å–∫–∞–π—Ç–µ –±—ë–¥—Ä–∞, –Ω–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ""",

            "—Å–∫—Ä—É—á–∏–≤–∞–Ω–∏—è": """üèãÔ∏è **–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è** - —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–µ—Å—Å

‚Ä¢ –õ—è–≥—Ç–µ –Ω–∞ —Å–ø–∏–Ω—É, –∫–æ–ª–µ–Ω–∏ —Å–æ–≥–Ω—É—Ç—ã, —Å—Ç–æ–ø—ã –Ω–∞ –ø–æ–ª—É
‚Ä¢ –†—É–∫–∏ –∑–∞ –≥–æ–ª–æ–≤–æ–π, –ª–æ–∫—Ç–∏ —Ä–∞–∑–≤–µ–¥–µ–Ω—ã –≤ —Å—Ç–æ—Ä–æ–Ω—ã
‚Ä¢ –ù–∞ –≤—ã–¥–æ—Ö–µ –æ—Ç–æ—Ä–≤–∏—Ç–µ –ª–æ–ø–∞—Ç–∫–∏ –æ—Ç –ø–æ–ª–∞
‚Ä¢ –°–æ–∫—Ä–∞—â–∞–π—Ç–µ –ø—Ä–µ—Å—Å, –Ω–µ —Ç—è–Ω–∏—Ç–µ —à–µ—é —Ä—É–∫–∞–º–∏
‚Ä¢ –í –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ –∑–∞–¥–µ—Ä–∂–∏—Ç–µ—Å—å –Ω–∞ 1 —Å–µ–∫—É–Ω–¥—É
‚Ä¢ –ù–∞ –≤–¥–æ—Ö–µ –æ–ø—É—Å—Ç–∏—Ç–µ—Å—å –º–µ–¥–ª–µ–Ω–Ω–æ –≤–Ω–∏–∑

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –¥—ë—Ä–≥–∞–π—Ç–µ —à–µ—é —Ä—É–∫–∞–º–∏, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–µ—Ä—Ü–∏—é, –Ω–µ –æ—Ç—Ä—ã–≤–∞–π—Ç–µ –ø–æ—è—Å–Ω–∏—Ü—É –æ—Ç –ø–æ–ª–∞""",

            "–ø—Ä–µ—Å—Å": """üèãÔ∏è **–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–µ—Å—Å** - —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –Ω–∞ –ø—Ä–µ—Å—Å

‚Ä¢ –õ—è–≥—Ç–µ –Ω–∞ —Å–ø–∏–Ω—É, –∫–æ–ª–µ–Ω–∏ —Å–æ–≥–Ω—É—Ç—ã, —Å—Ç–æ–ø—ã –Ω–∞ –ø–æ–ª—É
‚Ä¢ –†—É–∫–∏ –∑–∞ –≥–æ–ª–æ–≤–æ–π, –ª–æ–∫—Ç–∏ —Ä–∞–∑–≤–µ–¥–µ–Ω—ã
‚Ä¢ –ù–∞ –≤—ã–¥–æ—Ö–µ –ø–æ–¥–Ω–∏–º–∏—Ç–µ –ª–æ–ø–∞—Ç–∫–∏ –æ—Ç –ø–æ–ª–∞
‚Ä¢ –°–æ–∫—Ä–∞—â–∞–π—Ç–µ –ø—Ä–µ—Å—Å, –Ω–µ —Ç—è–Ω–∏—Ç–µ —à–µ—é —Ä—É–∫–∞–º–∏
‚Ä¢ –í –≤–µ—Ä—Ö–Ω–µ–π —Ç–æ—á–∫–µ –∑–∞–¥–µ—Ä–∂–∏—Ç–µ—Å—å –Ω–∞ 1 —Å–µ–∫
‚Ä¢ –ù–∞ –≤–¥–æ—Ö–µ –æ–ø—É—Å—Ç–∏—Ç–µ—Å—å

‚ö†Ô∏è **–û—à–∏–±–∫–∏:** –Ω–µ –¥—ë—Ä–≥–∞–π—Ç–µ —à–µ—é, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω–µ—Ä—Ü–∏—é""",
        }

        normalized_name = exercise_name.lower().strip()
        if normalized_name in instructions:
            return instructions[normalized_name]
        
        return f"""üèãÔ∏è **{exercise_name.title()}**

‚Ä¢ –í—Å—Ç–∞–Ω—å—Ç–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ —Å–ø–∏–Ω—É –ø—Ä—è–º–æ–π –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –∫–∞–∂–¥—É—é —Ñ–∞–∑—É –¥–≤–∏–∂–µ–Ω–∏—è
‚Ä¢ –î—ã—à–∏—Ç–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ (–≤–¥–æ—Ö - –æ–ø—É—Å–∫–∞–Ω–∏–µ, –≤—ã–¥–æ—Ö - –ø–æ–¥—ä—ë–º)
‚Ä¢ –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –ª—ë–≥–∫–æ–≥–æ –≤–µ—Å–∞ –¥–ª—è –æ—Å–≤–æ–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏–∫–∏

‚ö†Ô∏è –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –±–æ–ª–µ–≤—ã—Ö –æ—â—É—â–µ–Ω–∏–π –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ."""


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–æ—É—Ç–µ—Ä–∞
router = RequestRouter()