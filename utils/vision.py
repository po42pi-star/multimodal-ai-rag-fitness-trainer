"""
–£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é Vision –º–æ–¥–µ–ª–∏.
"""
import os
import logging
from typing import Tuple

logger = logging.getLogger(__name__)


def analyze_food_image(image_path: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –µ–¥—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–æ—Ä–∏—è—Ö.
    
    Args:
        image_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    Returns:
        str: –û–ø–∏—Å–∞–Ω–∏–µ –±–ª—é–¥–∞ —Å –∫–∞–ª–æ—Ä–∏—è–º–∏ –∏ –ë–ñ–£
    """
    from services.openai_client import openai_client
    
    prompt = """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ –±–ª—é–¥–æ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏:
1. –ß—Ç–æ —ç—Ç–æ –∑–∞ –±–ª—é–¥–æ
2. –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–ª–æ—Ä–∏–π
3. –ë–µ–ª–∫–∏, –∂–∏—Ä—ã, —É–≥–ª–µ–≤–æ–¥—ã (–ë–ñ–£)
4. –î–∞–π –∫—Ä–∞—Ç–∫—É—é –æ—Ü–µ–Ω–∫—É (–ø–æ–ª–µ–∑–Ω–æ/–Ω–µ –æ—á–µ–Ω—å –¥–ª—è —Ñ–∏—Ç–Ω–µ—Å–∞)

–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
üçΩÔ∏è **–ë–ª—é–¥–æ:** [–Ω–∞–∑–≤–∞–Ω–∏–µ]
üìä **–ö–∞–ª–æ—Ä–∏–∏:** ~XXX –∫–∫–∞–ª
üí™ **–ë–µ–ª–∫–∏:** X–≥ | **–ñ–∏—Ä—ã:** X–≥ | **–£–≥–ª–µ–≤–æ–¥—ã:** X–≥
‚≠ê **–û—Ü–µ–Ω–∫–∞:** [–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π]
"""
    
    try:
        result = openai_client.analyze_image(image_path, prompt)
        return result
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ–¥—ã: {e}")
        return "üòî –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ!"


def analyze_any_image(image_path: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª—é–±–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ.
    
    Args:
        image_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    Returns:
        str: –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    """
    from services.openai_client import openai_client
    
    prompt = """–û–ø–∏—à–∏ —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ. –ï—Å–ª–∏ —ç—Ç–æ –µ–¥–∞ - –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –∫–∞–ª–æ—Ä–∏—è—Ö.
–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –µ–¥–∞ - –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ —á—Ç–æ –≤–∏–¥–∏—à—å. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ."""
    
    try:
        result = openai_client.analyze_image(image_path, prompt)
        return result
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        return "üòî –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."


def is_food_image(image_path: str) -> bool:
    """
    –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - –º–æ–∂–µ—Ç –ª–∏ —ç—Ç–æ –±—ã—Ç—å –µ–¥–∞.
    
    Args:
        image_path: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    
    Returns:
        bool: True –µ—Å–ª–∏ –ø–æ—Ö–æ–∂–µ –Ω–∞ –µ–¥—É
    """
    from services.openai_client import openai_client
    
    prompt = """–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º:
–ï—Å–ª–∏ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ –µ–¥–∞ –∏–ª–∏ –Ω–∞–ø–∏—Ç–æ–∫ - –æ—Ç–≤–µ—Ç—å "FOOD"
–ï—Å–ª–∏ —ç—Ç–æ –∂–∏–≤–æ—Ç–Ω–æ–µ, —á–µ–ª–æ–≤–µ–∫, –ø–µ–π–∑–∞–∂, –∑–¥–∞–Ω–∏–µ, –º–∞—à–∏–Ω–∞ –∏–ª–∏ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ - –æ—Ç–≤–µ—Ç—å "NOT_FOOD"
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."""
    
    try:
        result = openai_client.analyze_image(image_path, prompt).strip().upper()
        return "FOOD" in result
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∏–ø–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        return True  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —ç—Ç–æ –µ–¥–∞